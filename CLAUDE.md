# **CLAUDE.md**







## **🔰 Objective**





Build a production-ready Go MCP server (ufo-mcp-go) that:



1. Exposes the **11 capabilities** defined in *MCP_UFO_PLAN.md*.
2. Persists user-defined lighting effects in /data/effects.json.
3. Streams **stateEvents** so multiple MCP clients stay in sync.
4. Ships as a tiny Docker image (<20 MB, static build).







## **📐 Design Guard-Rails**





- Keep tool count ≤ 20.
- Rich natural-language descriptions & examples on every tool.
- playEffect & stopEffects must send **progress events** (event:"progress").
- Protect shared state with sync.RWMutex – no global data races (run go test -race).
- Validate all inputs (JSON Schema generated by mcp-go + manual sanity checks for sendRawApi).
- Return meaningful MCP errors (isError:true) on UFO timeouts.







## **🛠 Coding Checklist**





- go mod init github.com/starspace46/ufo-mcp-go
- Implement internal/device package (HTTP wrapper, retries).
- Implement internal/effects (load/save/CRUD, mutex).
- Define Event struct + fan-out broadcaster.
- Register tools/resources in cmd/server/main.go.
- Unit tests for CRUD & ring pattern builder.
- make docker builds image.

## **📚 Library Usage Guidelines**

- **First attempt**: Use local package inspection and examples
- **Second attempt**: ALWAYS check official web documentation when facing library errors
- **Third attempt**: Check GitHub issues or community resources

## **🧪 Testing Requirements**

**MANDATORY WORKFLOW**: All code changes MUST follow this process:

1. **Before ANY code change**: `make pre-commit`
2. **After ANY code change**: `make change` 
3. **Before install/deploy**: `make test` (must pass)
4. **Write tests FIRST** for new features/bugs
5. **Manual testing** in Claude Desktop after `make install`

**Test Coverage Requirements**:
- Unit tests for ALL tool implementations
- Error condition testing (validation, API failures)
- Event publishing verification  
- Integration tests for MCP protocol compliance

**Critical Test Cases**:
- Tool definitions (schema validation)
- Parameter validation and error handling
- UFO API command generation
- Event broadcasting functionality







## **🧪 Testing**





- Use UFO_IP=127.0.0.1 + httptest server for device calls.
- Cover: add/update/delete effect, duplicate names, invalid patterns.
- Integration test: spin server, websocket-listen to SSE, call playEffect, assert progress events count.







## **✔️ Definition of Done**





- All checklist boxes ticked.
- go test ./... -race clean.
- docker run followed by curl -N localhost:8080/.well-known/mcp/tools lists 11 tools.
- Manual call playEffect(policeLights,5) visibly drives UFO.
- Local test with Claude Desktop controls the actual UFO